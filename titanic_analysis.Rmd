---
title: "타이타닉 생존자 예측 탐색적 분석"
author: '*이상민*'
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## 데이터 설명
| Variable | Definition | Key |
| -- | -- | -- |
| PassengerId | 탑승객 ID |  |
| Survived | 생존여부 | 0 = No, 1 = Yes |
| Pclass | 좌석 등급 | 1 = 1st, 2 = 2nd, 3 = 3rd |
| Name | 이름 |  |
| Sex | 성별 |  |
| Age | 나이 |  |
| SibSp | 함께 탑승한 형제 자매 또는 배우자 수 |  |
| Parch | 함께 탑승한 부모, 아이의 수 |  |
| Ticket | 티켓 번호 |  |
| Fare | 요금 |  |
| Cabin | 객실 번호 |  |
| Embarked | 탑승 항구| C = Cherbourg, Q = Queenstown, S = Southampton |

***

## 데이터 준비
```{r, message = FALSE, warning = FALSE}
library(ggplot2)
library(dplyr)
library(gridExtra)
library(DMwR)

setwd("C:/Users/sangmin/Desktop/github/kaggle/titanic")
train <- read.csv("train.csv")
test <- read.csv("test.csv")

str(train)
str(test)
```

데이터를 통합하기 위해 test 데이터셋에도 Survived 열을 만든 후 NA값을 넣어준다.
```{r}
test$Survived <- NA
train$Survived <- factor(train$Survived, levels=c(0, 1),
                         labels=c("No", "Yes"))

total <- rbind(train, test)
str(total)
```

***

## 데이터 탐색
### NA값 처리
데이터에 존재하는 NA값과 해당 비율을 확인한다.
```{r}
NA_num <- t(colSums(is.na(total)))
NA_prob <- t(colSums(is.na(total))) / nrow(total)
rbind(NA_num, NA_prob)
```
Survived 열에서 나오는 NA값은 모두 test 데이터셋에 해당하므로 그 외 Age와 Fare 열의 NA값을 각각 평균값으로 대치한다.
```{r}
age_sum <- total[complete.cases(total$Age), "Age"]
age_mean <- sum(age_sum) / length(age_sum)
fare_sum <- total[complete.cases(total$Fare), "Fare"]
fare_mean <- sum(fare_sum) / length(fare_sum)

for(i in 1:nrow(total)) {
    if (is.na(total$Age[i]) == TRUE) {
        total$Age[i] <- age_mean
    } else if (is.na(total$Fare[i]) == TRUE) {
        total$Fare[i] <- fare_mean
    }
}

colSums(is.na(total))
```

### PassengerId 변수
탑승객 ID는 단순히 겹치는 것이 없는지만 확인한다.
```{r}
length(unique(total$PassengerId)) == length(total$PassengerId)
```

### Survived 변수
Survived 변수는 예측해야 하는 종속 변수이다. train 데이터셋에만 값이 들어있기 때문에 그 값을 토대로 탑승객의 생존 여부를 시각화한다. 그래프를 보면 생존하지 못한 사람이 약 1.5배 더 많다.
```{r}
table(total$Survived)

ggplot(train) +
    geom_bar(aes(x=Survived, fill=Survived)) +
    ggtitle("number of passengers survived") +
    theme(plot.title=element_text(size=20, face="bold"))
```

### Pclass 변수
좌석 등급별 탑승객 수를 시각화한다. 3rd 좌석에 탑승한 승객이 가장 많다는 것을 알 수 있다.
```{r}
str(total$Pclass)

total$Pclass <- factor(total$Pclass, levels=c(1, 2, 3),
                       labels=c("1st", "2nd", "3rd"))

ggplot(total) +
    geom_bar(aes(x=Pclass, fill=Pclass)) +
    ggtitle("number of passengers by seat class") +
    theme(plot.title=element_text(size=20, face="bold"))
```

종속 변수인 Survived와의 관계를 보면 p-value 값이 굉장히 작아 두 변수는 독립이 아님을 확인할 수 있다.
```{r}
with(train, table(Survived, Pclass))
with(train, chisq.test(Survived, Pclass))
```

### Sex 변수
성별 탑승객 수를 시각화한다. 남성 탑승객이 여성 탑승객의 약 2배 가량 많다.
```{r}
table(total$Sex)

ggplot(total) +
    geom_bar(aes(x=Sex, fill=Sex)) +
    ggtitle("number of passengers by sex") +
    theme(plot.title=element_text(size=20, face="bold"))
```

똑같이 Survived 변수와의 관계를 보면 두 변수 또한 독립이 아님을 알 수 있다.
```{r}
with(train, table(Survived, Sex))
with(train, chisq.test(Survived, Pclass))
```

### Age 변수
binwidth 값을 달리해 나이별 탑승객 수를 시각화한다. 그래프에서 보면 알 수 있듯이 특정 나이 구간에 탑승객이 몰려있는데, 이는 결측값 처리를 Age 변수의 평균값으로 했기 때문이다.  
```{r}
mean(total$Age)


age_10 <- ggplot(total) +
    geom_histogram(aes(x=Age), binwidth=10) +
    ggtitle("bin = 10")
age_1 <- ggplot(total) + 
    geom_histogram(aes(x=Age), binwidth=1) +
    ggtitle("bin = 1")

grid.arrange(age_10, age_1, ncol=2)
```

따라서 knnImputation() 함수를 사용해 결측값 처리를 다시 해준다. knn 알고리즘은 다음 두 가지 조건을 만족해야 한다.

 - 연속형 변수에 사용
 - 독립 변수만 가능 (종속 변수를 예측해서 채워넣으면 안됨)
 
Age 변수는 연속형 변수이고, 종속 변수가 아니기 때문에 두 가지 조건을 모두 만족한다. 대체한 결측값으로 그래프를 다시 그리면 아래와 같다.
```{r}
total[which(total$Age == mean(total$Age)), "Age"] <- NA

knn <- knnImputation(total)
total$Age <- knn$Age

knn_age_10 <- ggplot(total) +
    geom_histogram(aes(x=Age), binwidth=10) +
    ggtitle("bin = 10")
knn_age_1 <- ggplot(total) + 
    geom_histogram(aes(x=Age), binwidth=1) +
    ggtitle("bin = 1")

grid.arrange(knn_age_10, knn_age_1, ncol=2)
```

Age 변수의 가장 큰 데이터값은 80이다. 따라서 5살 단위로 나눠 age_group을 생성하여 나이대별 생존 비율을 시각화한다.
```{r}
dt <- total[1:nrow(train), ]

max(dt$Age)
age_group <- cut(dt$Age, c(seq(0, 80, 5)))

surv <- as.numeric(dt$Survived) - 1
df <- data.frame(age_group, surv)

df_surv_cnt <- aggregate(df$surv, by=list(age_group), sum)
df_age_cnt <- aggregate(df$surv, by=list(age_group), length)

df <- cbind(df_surv_cnt, df_age_cnt$x)
colnames(df) <- c("range", "survived", "count")
df$ratio <- with(df, survived / count) 

ggplot(df, aes(x=range, y=ratio)) +
    geom_bar(stat="identity", width=0.7, fill="purple") +
    ggtitle("ratio of passengers by age group") +
    theme(plot.title=element_text(size=20, face="bold"))
```

영유아의 생존율이 가장 높다는 것을 확인할 수 있다.
```{r}
rbind(head(df, 3), tail(df, 3))
```

### Cabin 변수
객실 번호가 공백으로 저장된 데이터가 상당히 많다. 생존자를 예측하기 위해서는 열 전체를 삭제하는 것이 바람직할 것 같다.
```{r}
head(table(total$Cabin))
sum(total$Cabin == "")
```

### Embarked 변수
Embarked 변수에도 2개의 공백이 포함되어 있다. Southampton 항구에서의 탑승객이 가장 많기 때문에 데이터를 대체해준다.
```{r}
table(total$Embarked)
str(total$Embarked)

total[which(total$Embarked == ""), "Embarked"] <- "S"
```
팩터를 4 level에서 3 level로 변경해주고 항구별 탑승객 수를 시각화한다.
```{r}
total$Embarked <- as.factor(as.character(total$Embarked))
str(total$Embarked)

ggplot(total) +
    geom_bar(aes(x=Embarked, fill=Embarked)) +
    ggtitle("number of passengers by embarked") +
    theme(plot.title=element_text(size=20, face="bold")) 
```

종속 변수와의 관계를 보면 p-value 값이 매우 작아 두 변수 역시 독립이 아님을 알 수 있다.
```{r}
with(total, table(Survived, Embarked))
with(total, chisq.test(Survived, Embarked))
```